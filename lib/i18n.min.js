'use strict';

var mode = '{lang}/page';
var i18nType = ['i18n-c', 'i18n-k', 'i18n-p', 'i18n-s'];

window.addEventListener('load', function () {
    var lang = window.localStorage.getItem("JmI18nLang") || '';
    if(lang == ''){
        window.localStorage.setItem("JmI18nLang", "cn");
    }
    hasI18n();
    var langBtn = document.querySelectorAll('[i18n-lang-btn]');
    for(var i=0;i<langBtn.length;i++){
        langBtn[i].addEventListener('click', function () {
            window.localStorage.setItem('JmI18nLang', this.getAttribute('i18n-lang-btn'));
            hasI18n();
        });
    }
});

function hasI18n() {
    var _uri = getPath();
    if (!(_uri === '')) {
        var lang = window.localStorage.getItem('JmI18nLang');
        var i18nURL = '/' + getPath().replace('{lang}', lang) + '.json';

        i18nType.some(function (i) {
            var _el = document.querySelectorAll('[' + i + ']');
            if (_el.length > 0) {
                switch (i) {
                    case 'i18n-p':
                        if (!(_uri === 'p')) {
                            fetchData({
                                url: i18nURL,
                                type: 'i18n-p',
                                el: _el,
                                cb: function cb(data) {
                                    i18nImg('i18n-p-i', data);
                                    i18nPlaceholder('i18n-p-ph', data);
                                }
                            });
                        }
                        break;
                    case 'i18n-c':
                        fetchData({
                            url: '/i18n/glob/common.' + lang + '.json',
                            type: 'i18n-c',
                            el: _el,
                            cb: function cb(data) {
                                i18nImg('i18n-c-i', data);
                                i18nPlaceholder('i18n-c-ph', data);
                            }
                        });
                        break;
                    case 'i18n-k':
                        fetchData({
                            url: '/i18n/glob/keyword.' + lang + '.json',
                            type: 'i18n-k',
                            el: _el,
                            cb: function cb(data) {
                                return i18nPlaceholder('i18n-k-ph', data);
                            }
                        });
                        break;
                    case 'i18n-s':
                        for(var i=0;i<_el.length;i++){
                            var d = _el[i];
                            d.classList.remove('i18n-cn', 'i18n-en');
                            d.classList.add('i18n-' + lang);
                        }
                        break;
                    default:
                        break;
                }
            }
        });
    }
}

function fetchData(opts) {
    var init = {
        method: 'GET',
        headers: new Headers().append('Content-Type', 'application/json'),
        mode: 'cors',
        cache: 'default'
    };

    fetch(opts.url, init).then(function (res) {
        return res.json();
    }).then(function (data) {
        for(var i=0;i<opts.el.length;i++){
            var d = opts.el[i];
            d.innerHTML = data[d.getAttribute(opts.type)];
        }
        opts.cb ? opts.cb(data) : '';
        
    }, function (err) {
        console.log('%c Not `i18n` page please set: %c <meta i18n-unset> ', 'background: yellow; color: #000; font-size: 18px;', 'background: #fff; color: red; font-weight: bold; font-size: 18px;');
        console.log('%c meta attribute: %c i18n-uset | i18n-uset=\'p\'', 'font-size: 18px; font-weight: bold;', 'background: #fff; color: green; font-size: 18px; font-weight: bold;');
    });
}

function i18nImg(type, data) {
    var _el = document.querySelectorAll('[' + type + ']');
    for(var i=0;i<_el.length;i++){
        var d = _el[i];
        d.setAttribute('src', data[d.getAttribute(type)]);
    }
}

function i18nPlaceholder(type, data) {
    var _el = document.querySelectorAll('[' + type + ']');
    for(var i=0;i<_el.length;i++){
        var d = _el[i];
        d.setAttribute('placeholder', data[d.getAttribute(type)]);
    }
}

function getPath() {
    var i18nPath = document.querySelector('[i18n-path]');
    var setI18n = document.querySelector('[i18n-unset]');
    var _path = i18nPath !== null ? i18nPath.attributes['i18n-path'].value : setI18n === null ? mode.replace('/page', location.pathname.split('.')[0]) : setI18n.getAttribute('i18n-unset');

    _path = /\/$/.test(_path) ? _path + 'index' : _path;
    return _path;
}